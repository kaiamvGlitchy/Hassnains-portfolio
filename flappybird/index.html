<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .background {
            height: 100vh;
            width: 100vw;
            background: url('bg.jpg') no-repeat center center/cover;
            position: absolute;
        }

        .bird {
            height: 80px; /* Smaller bird */
            width: 120px;
            position: fixed;
            top: 40vh;
            left: 30vw;
            z-index: 100;
        }

        .pipe_sprite {
            position: fixed;
            width: 6vw;
            background: url('pipe.png') no-repeat center center/cover;
            border-radius: 20px; /* Curved pipes */
        }

        .message {
            position: fixed;
            z-index: 10;
            height: 10vh;
            font-size: 5vh;
            font-weight: bold;
            color: black;
            top: 15vh;
            left: 30vw;
            text-align: center;
        }

        .score {
            position: fixed;
            z-index: 10;
            font-size: 5vh;
            font-weight: bold;
            color: black; /* Changed score color */
            top: 2vh;
            left: 2vw;
        }

        /* Exit Button */
        .exit-btn {
            position: fixed;
            top: 2vh;
            right: 2vw;
            background: none;
            border: none;
            font-size: 3vh;
            font-weight: bold;
            cursor: pointer;
            color: red;
        }
        .exit-btn:hover {
            color: darkred;
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <img class="bird" src="bird.png" alt="bird-img">
    <div class="message">Tap to Start</div>
    <div class="score">
        <span class="score_title">Score: </span>
        <span class="score_val">0</span>
    </div>
    <!-- Exit Button -->
    <button class="exit-btn" onclick="window.location.href='../games/index.html'">âœ–</button>

    <script>
        // Game Variables
        let move_speed = 3;
        let gravity = 0.15; // Balanced gravity for smoother gameplay
        let bird = document.querySelector('.bird');
        let bird_props = bird.getBoundingClientRect();
        let background = document.querySelector('.background').getBoundingClientRect();
        let score_val = document.querySelector('.score_val');
        let message = document.querySelector('.message');
        let score_title = document.querySelector('.score_title');
        let game_state = 'Start';

        // Detect if the device is an iPad
        function isIpad() {
            return /iPad|Macintosh/.test(navigator.userAgent) && 'ontouchend' in document;
        }

        // Function to Start the Game
        function startGame() {
            if (game_state !== 'Play') {
                document.querySelectorAll('.pipe_sprite').forEach((e) => e.remove());
                bird.style.top = '40vh';
                game_state = 'Play';
                message.innerHTML = '';
                score_title.innerHTML = 'Score: ';
                score_val.innerHTML = '0';
                play();
            }
        }

        // Apply correct event listener based on device
        if (isIpad()) {
            document.addEventListener('touchstart', () => startGame());
        } else {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') startGame();
            });
        }

        // Main Game Loop
        function play() {
            function move() {
                if (game_state !== 'Play') return;

                let pipe_sprites = document.querySelectorAll('.pipe_sprite');
                pipe_sprites.forEach((element) => {
                    let pipe_props = element.getBoundingClientRect();
                    bird_props = bird.getBoundingClientRect();

                    // Remove pipes when off-screen
                    if (pipe_props.right <= 0) {
                        element.remove();
                    } else {
                        // Collision Detection
                        if (
                            bird_props.left < pipe_props.left + pipe_props.width &&
                            bird_props.left + bird_props.width > pipe_props.left &&
                            bird_props.top < pipe_props.top + pipe_props.height &&
                            bird_props.top + bird_props.height > pipe_props.top
                        ) {
                            game_state = 'End';
                            message.innerHTML = 'Tap to Restart';
                            message.style.left = '28vw';
                            return;
                        } else {
                            // Increase Score if Bird Passes Pipe
                            if (
                                pipe_props.right < bird_props.left &&
                                pipe_props.right + move_speed >= bird_props.left &&
                                element.increase_score === '1'
                            ) {
                                score_val.innerHTML = +score_val.innerHTML + 1;
                            }
                            element.style.left = pipe_props.left - move_speed + 'px';
                        }
                    }
                });

                requestAnimationFrame(move);
            }
            requestAnimationFrame(move);

            let bird_dy = 0;

            // Gravity Application
            function apply_gravity() {
                if (game_state !== 'Play') return;
                bird_dy += gravity;

                document.addEventListener('keydown', (e) => {
                    if ((e.key === 'ArrowUp' || e.key === ' ') && game_state === 'Play') {
                        bird_dy = -3; // Reduced jump height
                    }
                });

                document.addEventListener('touchstart', () => {
                    if (game_state === 'Play') {
                        bird_dy = -3;
                    }
                });

                // Collision with ground or top of screen
                if (bird_props.top <= 0 || bird_props.bottom >= background.bottom) {
                    game_state = 'End';
                    message.innerHTML = 'Tap to Restart';
                    message.style.left = '28vw';
                    return;
                }

                bird.style.top = bird_props.top + bird_dy + 'px';
                bird_props = bird.getBoundingClientRect();
                requestAnimationFrame(apply_gravity);
            }
            requestAnimationFrame(apply_gravity);

            let pipe_separation = 0;
            let pipe_gap = 35;

            function create_pipe() {
                if (game_state !== 'Play') return;

                if (pipe_separation > 115) {
                    pipe_separation = 0;
                    let pipe_pos = Math.floor(Math.random() * 43) + 8;

                    let pipe_top = document.createElement('div');
                    pipe_top.className = 'pipe_sprite';
                    pipe_top.style.top = pipe_pos - 70 + 'vh';
                    pipe_top.style.left = '100vw';
                    document.body.appendChild(pipe_top);

                    let pipe_bottom = document.createElement('div');
                    pipe_bottom.className = 'pipe_sprite';
                    pipe_bottom.style.top = pipe_pos + pipe_gap + 'vh';
                    pipe_bottom.style.left = '100vw';
                    pipe_bottom.increase_score = '1';
                    document.body.appendChild(pipe_bottom);
                }

                pipe_separation++;
                requestAnimationFrame(create_pipe);
            }
            requestAnimationFrame(create_pipe);
        }
    </script>
</body>
</html>
